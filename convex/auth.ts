import { createClient, type GenericCtx } from '@convex-dev/better-auth'
import { convex, crossDomain } from '@convex-dev/better-auth/plugins'
import { components } from './_generated/api'
import { DataModel } from './_generated/dataModel'
import { query } from './_generated/server'
import { betterAuth, type BetterAuthOptions } from 'better-auth/minimal'
import authConfig from './auth.config'
import { env } from './env'
import authSchema from './betterAuth/schema'
import { organization, phoneNumber } from 'better-auth/plugins'

const siteUrl = env.SITE_URL

// The component client has methods needed for integrating Convex with Better Auth,
// as well as helper methods for general use.
export const authComponent = createClient<DataModel, typeof authSchema>(
  components.betterAuth,
  {
    local: {
      schema: authSchema,
    },
  },
)

export const createAuthOptions = (ctx: GenericCtx<DataModel>) => {
  return {
    trustedOrigins: [siteUrl],
    database: authComponent.adapter(ctx),

    socialProviders: {
      google: {
        clientId: env.GOOGLE_CLIENT_ID,
        clientSecret: env.GOOGLE_CLIENT_SECRET,
      },
    },

    plugins: [
      // The cross domain plugin is required for client side frameworks
      crossDomain({ siteUrl }),
      // The Convex plugin is required for Convex compatibility
      convex({ authConfig }),

      organization({}),

      phoneNumber({
        sendOTP(data, ctx) {
          // TODO: Implement your OTP sending logic here.
          // For example, integrate with Twilio or another SMS service.
          console.log(
            `Sending OTP ${data.code} to phone number ${data.phoneNumber}`,
          )
        },
      }),
    ],
  } satisfies BetterAuthOptions
}

export const createAuth = (ctx: GenericCtx<DataModel>) => {
  return betterAuth(createAuthOptions(ctx))
}

// Example function for getting the current user
// Feel free to edit, omit, etc.
export const getCurrentUser = query({
  args: {},
  handler: async (ctx) => {
    return authComponent.getAuthUser(ctx)
  },
})
